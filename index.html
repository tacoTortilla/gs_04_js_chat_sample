<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>chatApp</title>
  <style>
    #output li {
      background: #ccc;
    }

    .small_image_height50pix {
	height: 50px; /* ç”»åƒã®é«˜ã•ã‚’80ãƒ”ã‚¯ã‚»ãƒ«ã«è¨­å®š */
	width: auto; /* å¹…ã¯è‡ªå‹•èª¿æ•´ã—ã¦ç¸¦æ¨ªæ¯”ã‚’ç¶­æŒ */
}
  </style>

</head>

<body>
  <h1>å¥åº·çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯</h1>
  <a href="https://tacotortilla.github.io/gs_00_cheese_academy/#section6">ã‚¦ã‚·ã®æ°—æŒã¡ç¢ºèª</a>
  <p>
    ã‚¦ã‚·å¤ªéƒ<br>
    ã‚¦ã‚·å­<br>
    ã‚¸ãƒ¼å­
  </p>
  <!-- å…¥åŠ›å ´æ‰€ã‚’ä½œæˆã—ã‚ˆã† -->
  <form>
    <fieldset>
      <legend>å¥åº·ã§ã™ã‹ï¼Ÿ</legend>
      <div>
       name: <input type="text" id="name">
      </div>
      <div>
        message: <input type="text" id="text">
      </div>
      <div>
        <button type="button" id="send">send</button>
      </div>
    </fieldset>
  </form>

  <!-- ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›å ´æ‰€ -->
  <div id="output" style="overflow: auto; height:300px;"></div>

 

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script>
    // æ—¥æ™‚ã‚’ã„ã„æ„Ÿã˜ã®å½¢å¼ã«ã™ã‚‹é–¢æ•°
    function convertTimestampToDatetime(timestamp) {
      const _d = timestamp ? new Date(timestamp * 1000) : new Date();
      const Y = _d.getFullYear();
      const m = (_d.getMonth() + 1).toString().padStart(2, '0');
      const d = _d.getDate().toString().padStart(2, '0');
      const H = _d.getHours().toString().padStart(2, '0');
      const i = _d.getMinutes().toString().padStart(2, '0');
      const s = _d.getSeconds().toString().padStart(2, '0');
      return `${Y}/${m}/${d} ${H}:${i}:${s}`;


    }
  </script>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // ğŸ”½ è¿½åŠ  / `9.2.0`ã®éƒ¨åˆ†ã‚’â†‘ã®Firestoreã‹ã‚‰è²¼ã‚Šä»˜ã‘ãŸã‚³ãƒ¼ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ã‚‹
    // onSnapshot() ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚‚ã®
    // query ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã«æ¡ä»¶ã‚’ä»˜ã‘ã‚‹äº‹ãŒã§ãã‚‹
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      onSnapshot,
      query,
      orderBy,
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "",
      authDomain: "chat-app2-9809a.firebaseapp.com",
      projectId: "chat-app2-9809a",
      storageBucket: "chat-app2-9809a.firebasestorage.app",
      messagingSenderId: "51724305747",
      appId: "1:51724305747:web:09b6dbb9fe5cf6c6edcda6"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // ğŸ”½ è¿½åŠ 
    const db = getFirestore(app);

    //è‰¯ãåˆ†ã‹ã‚‰ãªã„ãƒ‡ãƒ¼ã‚¿ã‚’ãã‚Œã„ãªãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã—ã¦ãã‚Œã‚‹é–¢æ•°
    // ã€ŒFirestore å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã€ã‚’å…¥åŠ›ã—ã¦ã€Œé…åˆ—å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã€ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ ã™ã‚‹
    function chatDocuments(fireStoreDocs) {
      const documents = [];
      fireStoreDocs.forEach(function (doc) {
        const document = {
          id: doc.id,
          data: doc.data(),
        };
        documents.push(document);
      });
      return documents;
    }

    // ã€Œé…åˆ—å½¢å¼ã«ã—ãŸãƒãƒ£ãƒƒãƒˆã®ãƒ‡ãƒ¼ã‚¿ã€ã‚’å…¥åŠ›ã—ã¦ã€Œè¡¨ç¤ºç”¨ã®ã‚¿ã‚°ã«ã„ã‚Œã¦ã€å‡ºåŠ›ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ ã™ã‚‹
    function chatElements(chatDocuments) {
      const elements = [];
      chatDocuments.forEach(function (document) {
        if(document.data.name === "ã‚¦ã‚·å¤ªéƒ"){
            elements.push(`
          <li id="${document.id}">
            <p>${convertTimestampToDatetime(document.data.date.seconds)}</p>
            <p><img src="img/factory04.jpg" alt="" class="small_image_height50pix"></p>
            <p>message:${document.data.text}</p>
          </li>
        `);            
        } else if(document.data.name === "ã‚¦ã‚·å­"){
            elements.push(`
          <li id="${document.id}">
            <p>${convertTimestampToDatetime(document.data.date.seconds)}</p>
            <p><img src="img/factory05.jpg" alt="" class="small_image_height50pix"></p>
            <p>message:${document.data.text}</p>
          </li>
        `);

        }else if(document.data.name === "ã‚¸ãƒ¼å­"){
            elements.push(`
          <li id="${document.id}">
            <p>${convertTimestampToDatetime(document.data.date.seconds)}</p>
            <p><img src="img/factory06.jpg" alt="" class="small_image_height50pix"></p>
            <p>message:${document.data.text}</p>
          </li>
        `);

        }else{
            elements.push(`
          <li id="${document.id}">
            <p>${convertTimestampToDatetime(document.data.date.seconds)}</p>
            <p>name:${document.data.name}</p>
            <p>message:${document.data.text}</p>
          </li>
        `);

        }

      });
      return elements;
    }


    // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
    //document.getElementById("close-popup-btn").addEventListener("click", closePopup);


    //ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    $("#send").on("click", function () {
        // é€ä¿¡æ™‚ã«å¿…è¦ãªå‡¦ç†
        const postData = {
          name: $("#name").val(),
          text: $("#text").val(),
          date: serverTimestamp(),
        };
        addDoc(collection(db, "chat"), postData);
        $("#text").val("");
        //log
        console.log("postData:", postData);
      });


    // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†
    // æ™‚é–“é †ã§å–ã£ã¦ãã‚‹å‡¦ç† queryã‚’ä½¿ã†
      const q = query(collection(db, "chat"), orderBy("date", "desc"));
      onSnapshot(q, (querySnapshot) => {
    //  onSnapshot(collection(db, "chat"), (querySnapshot) => {
        console.log(querySnapshot.docs);
        // firestore å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ querySnapshot.docs ã‚’å…¥åŠ›ã™ã‚‹
        const documents = chatDocuments(querySnapshot.docs);
        console.log(documents);
        // é…åˆ—å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦è¡¨ç¤ºç”¨ã®ã‚¿ã‚°ã«ã„ã‚Œã¦å‡ºåŠ›ã™ã‚‹
        const elements = chatElements(documents);
        $("#output").html(elements);

        });




  </script>

</body>

</html>